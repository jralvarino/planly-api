---
description: Automatically create DynamoDB table creation scripts when new tables are added
alwaysApply: true
---

# DynamoDB Table Script Creation Rule

When a new table is added to `src/db/dynamodb.tables.ts`, automatically create a corresponding table creation script in `scripts/`.

## When to Apply

This rule applies when:
- A new entry is added to `DYNAMO_TABLES` in `src/db/dynamodb.tables.ts`
- A new DynamoDB table is defined in `deployment/template.yaml`

## Required Actions

1. **Create the table creation script** at `scripts/create-{table-name}-table.sh`
2. **Update `scripts/init-dynamodb.sh`** to include the new script in the TABLES array

## Script Template

The script must follow this structure:

```bash
#!/bin/bash

# Script para criar a tabela {TableName} no DynamoDB local
# Baseado no modelo {ModelName} e na configura√ß√£o do template.yaml

# Configura√ß√µes
TABLE_NAME="{table-name}"
DYNAMODB_ENDPOINT="${DYNAMODB_ENDPOINT:-http://localhost:8000}"
REGION="${AWS_REGION:-us-east-1}"

echo "üöÄ Criando tabela {TableName} no DynamoDB local..."
echo "üìç Endpoint: $DYNAMODB_ENDPOINT"
echo "üìã Nome da tabela: $TABLE_NAME"

# Verificar se o DynamoDB local est√° rodando
if ! curl -s "$DYNAMODB_ENDPOINT" > /dev/null 2>&1; then
    echo "‚ùå Erro: DynamoDB local n√£o est√° acess√≠vel em $DYNAMODB_ENDPOINT"
    echo "üí° Certifique-se de que o DynamoDB local est√° rodando:"
    echo "   docker-compose up -d dynamodb"
    exit 1
fi

# Verificar se a tabela j√° existe
if aws dynamodb describe-table \
    --table-name "$TABLE_NAME" \
    --endpoint-url "$DYNAMODB_ENDPOINT" \
    --region "$REGION" \
    > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  A tabela $TABLE_NAME j√° existe!"
    read -p "Deseja deletar e recriar? (s/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        echo "üóëÔ∏è  Deletando tabela existente..."
        aws dynamodb delete-table \
            --table-name "$TABLE_NAME" \
            --endpoint-url "$DYNAMODB_ENDPOINT" \
            --region "$REGION" \
            > /dev/null 2>&1
        
        echo "‚è≥ Aguardando tabela ser deletada..."
        aws dynamodb wait table-not-exists \
            --table-name "$TABLE_NAME" \
            --endpoint-url "$DYNAMODB_ENDPOINT" \
            --region "$REGION"
    else
        echo "‚úÖ Tabela mantida como est√°."
        exit 0
    fi
fi

# Criar a tabela
echo "üì¶ Criando tabela..."

aws dynamodb create-table \
    --table-name "$TABLE_NAME" \
    --attribute-definitions \
        {attribute-definitions} \
    --key-schema \
        {key-schema} \
    --billing-mode PAY_PER_REQUEST \
    {global-secondary-indexes} \
    --endpoint-url "$DYNAMODB_ENDPOINT" \
    --region "$REGION" \
    > /dev/null

if [ $? -eq 0 ]; then
    echo "‚è≥ Aguardando tabela ficar ativa..."
    aws dynamodb wait table-exists \
        --table-name "$TABLE_NAME" \
        --endpoint-url "$DYNAMODB_ENDPOINT" \
        --region "$REGION"
    
    echo "‚úÖ Tabela $TABLE_NAME criada com sucesso!"
    echo ""
    echo "üìä Estrutura da tabela:"
    {structure-info}
    echo ""
    echo "üìù Campos do modelo {ModelName}:"
    {model-fields}
else
    echo "‚ùå Erro ao criar a tabela!"
    exit 1
fi
```

## Script Naming Convention

- Convert table name to kebab-case
- Example: `planly-category` ‚Üí `create-category-table.sh`
- Example: `user` ‚Üí `create-user-table.sh`

## Key Schema Patterns

### Simple Table (only partition key)
```bash
--key-schema \
    AttributeName={keyName},KeyType=HASH
```

### Composite Key (partition + sort key)
```bash
--key-schema \
    AttributeName={partitionKey},KeyType=HASH \
    AttributeName={sortKey},KeyType=RANGE
```

## Global Secondary Index (GSI) Pattern

If the table has a GSI:
```bash
--global-secondary-indexes \
    "[{
        \"IndexName\": \"{index-name}\",
        \"KeySchema\": [{\"AttributeName\": \"{attribute}\", \"KeyType\": \"HASH\"}],
        \"Projection\": {\"ProjectionType\": \"ALL\"}
    }]"
```

If no GSI, omit the `--global-secondary-indexes` parameter entirely.

## Updating init-dynamodb.sh

Add the new script to the TABLES array in `scripts/init-dynamodb.sh`:

```bash
TABLES=(
    "create-user-table.sh"
    "create-category-table.sh"
    "create-habit-table.sh"
    "create-todo-table.sh"
    "create-stats-table.sh"
    "create-{new-table}-table.sh"  # Add here
)
```

Maintain dependency order (tables without foreign keys first).

## Making Scripts Executable

Always run `chmod +x` on newly created scripts:

```bash
chmod +x scripts/create-{table-name}-table.sh
```

## Reference Files

- Table definitions: `src/db/dynamodb.tables.ts`
- CloudFormation template: `deployment/template.yaml`
- Model files: `src/models/{ModelName}.ts`
- Existing scripts: `scripts/create-*-table.sh`
