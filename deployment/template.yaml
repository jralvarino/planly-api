AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Planly API - Main Template

Parameters:
    AWSRegion:
        Type: String
        Default: us-east-1
        Description: AWS Region where resources will be created
    JwtSecret:
        Type: String
        Default: "your-secret-key-change-in-production"
        Description: Secret key for JWT token signing
        NoEcho: true

Resources:
    # ============================================
    # Shared Resources
    # ============================================

    # API Gateway REST API (Shared) - Using OpenAPI
    PlanlyApi:
        Type: AWS::Serverless::Api
        Properties:
            Name: planly-api
            StageName: prod
            DefinitionBody:
                Fn::Transform:
                    Name: AWS::Include
                    Parameters:
                        Location: openapi.yaml

    # ============================================
    # Category Module
    # ============================================

    # DynamoDB Table for Categories
    CategoryTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: planly-category
            BillingMode: PAY_PER_REQUEST
            AttributeDefinitions:
                - AttributeName: id
                  AttributeType: S
                - AttributeName: userId
                  AttributeType: S
            KeySchema:
                - AttributeName: id
                  KeyType: HASH
            GlobalSecondaryIndexes:
                - IndexName: userId-index
                  KeySchema:
                      - AttributeName: userId
                        KeyType: HASH
                  Projection:
                      ProjectionType: ALL

    # DynamoDB Table for Users
    UserTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: user
            BillingMode: PAY_PER_REQUEST
            AttributeDefinitions:
                - AttributeName: userId
                  AttributeType: S
            KeySchema:
                - AttributeName: userId
                  KeyType: HASH

    # IAM Role for Category Lambda
    CategoryLambdaExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: planly-api-category-lambda-role
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: lambda.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
            Policies:
                - PolicyName: DynamoDBAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - dynamodb:PutItem
                                - dynamodb:GetItem
                                - dynamodb:UpdateItem
                                - dynamodb:DeleteItem
                                - dynamodb:Query
                                - dynamodb:Scan
                            Resource:
                                - !GetAtt CategoryTable.Arn
                                - !Sub "${CategoryTable.Arn}/index/*"
                                - !GetAtt UserTable.Arn
                                - !Sub "${UserTable.Arn}/index/*"
                - PolicyName: SecretsManagerAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - secretsmanager:GetSecretValue
                            Resource:
                                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:planly/jwt*"

    # Lambda Permission for API Gateway
    CategoryLambdaApiGatewayInvokePermission:
        Type: AWS::Lambda::Permission
        Properties:
            FunctionName: !Ref CategoryLambdaFunction
            Action: lambda:InvokeFunction
            Principal: apigateway.amazonaws.com
            SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PlanlyApi}/*/*"

    # Category Lambda Function
    CategoryLambdaFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: planly-api-category-lambda
            Runtime: nodejs20.x
            Handler: dist/handlers/category/index.handler
            CodeUri: ..
            Role: !GetAtt CategoryLambdaExecutionRole.Arn
            Timeout: 30
            MemorySize: 256

    # ============================================
    # Habit Module
    # ============================================

    # DynamoDB Table for Habits
    HabitTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: planly-habit
            BillingMode: PAY_PER_REQUEST
            AttributeDefinitions:
                - AttributeName: id
                  AttributeType: S
                - AttributeName: userId
                  AttributeType: S
                - AttributeName: start_date
                  AttributeType: S
            KeySchema:
                - AttributeName: id
                  KeyType: HASH
            GlobalSecondaryIndexes:
                - IndexName: userId-index
                  KeySchema:
                      - AttributeName: userId
                        KeyType: HASH
                  Projection:
                      ProjectionType: ALL
                - IndexName: userId-start_date-index
                  KeySchema:
                      - AttributeName: userId
                        KeyType: HASH
                      - AttributeName: start_date
                        KeyType: RANGE
                  Projection:
                      ProjectionType: ALL

    # DynamoDB Table for Todos
    TodoTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: planly-todo
            BillingMode: PAY_PER_REQUEST
            AttributeDefinitions:
                - AttributeName: PK
                  AttributeType: S
                - AttributeName: SK
                  AttributeType: S
                - AttributeName: habitId
                  AttributeType: S
                - AttributeName: userId
                  AttributeType: S
                - AttributeName: date
                  AttributeType: S
            KeySchema:
                - AttributeName: PK
                  KeyType: HASH
                - AttributeName: SK
                  KeyType: RANGE
            GlobalSecondaryIndexes:
                - IndexName: habitId-index
                  KeySchema:
                      - AttributeName: habitId
                        KeyType: HASH
                  Projection:
                      ProjectionType: ALL
                - IndexName: userId-date-index
                  KeySchema:
                      - AttributeName: userId
                        KeyType: HASH
                      - AttributeName: date
                        KeyType: RANGE
                  Projection:
                      ProjectionType: ALL

    # DynamoDB Table for Stats
    StatsTable:
        Type: AWS::DynamoDB::Table
        Properties:
            TableName: planly-stats
            BillingMode: PAY_PER_REQUEST
            AttributeDefinitions:
                - AttributeName: PK
                  AttributeType: S
                - AttributeName: SK
                  AttributeType: S
            KeySchema:
                - AttributeName: PK
                  KeyType: HASH
                - AttributeName: SK
                  KeyType: RANGE

    # IAM Role for Habit Lambda
    HabitLambdaExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: planly-api-habit-lambda-role
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: lambda.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
            Policies:
                - PolicyName: DynamoDBAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - dynamodb:PutItem
                                - dynamodb:GetItem
                                - dynamodb:UpdateItem
                                - dynamodb:DeleteItem
                                - dynamodb:Query
                                - dynamodb:Scan
                            Resource:
                                - !GetAtt HabitTable.Arn
                                - !Sub "${HabitTable.Arn}/index/*"
                                - !GetAtt CategoryTable.Arn
                                - !Sub "${CategoryTable.Arn}/index/*"
                                - !GetAtt UserTable.Arn
                                - !Sub "${UserTable.Arn}/index/*"
                                - !GetAtt TodoTable.Arn
                                - !Sub "${TodoTable.Arn}/index/*"
                                - !GetAtt StatsTable.Arn
                                - !Sub "${StatsTable.Arn}/index/*"
                - PolicyName: SecretsManagerAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - secretsmanager:GetSecretValue
                            Resource:
                                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:planly/jwt*"

    # Lambda Permission for API Gateway
    HabitLambdaApiGatewayInvokePermission:
        Type: AWS::Lambda::Permission
        Properties:
            FunctionName: !Ref HabitLambdaFunction
            Action: lambda:InvokeFunction
            Principal: apigateway.amazonaws.com
            SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PlanlyApi}/*/*"

    # Habit Lambda Function
    HabitLambdaFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: planly-api-habit-lambda
            Runtime: nodejs20.x
            Handler: dist/handlers/habit/index.handler
            CodeUri: ..
            Role: !GetAtt HabitLambdaExecutionRole.Arn
            Timeout: 30
            MemorySize: 256

    # ============================================
    # Todo Module
    # ============================================

    # IAM Role for Todo Lambda
    TodoLambdaExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: planly-api-todo-lambda-role
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: lambda.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
            Policies:
                - PolicyName: DynamoDBAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - dynamodb:PutItem
                                - dynamodb:GetItem
                                - dynamodb:UpdateItem
                                - dynamodb:DeleteItem
                                - dynamodb:Query
                                - dynamodb:Scan
                            Resource:
                                - !GetAtt CategoryTable.Arn
                                - !Sub "${CategoryTable.Arn}/index/*"
                                - !GetAtt UserTable.Arn
                                - !Sub "${UserTable.Arn}/index/*"
                                - !GetAtt TodoTable.Arn
                                - !Sub "${TodoTable.Arn}/index/*"
                                - !GetAtt HabitTable.Arn
                                - !Sub "${HabitTable.Arn}/index/*"
                                - !GetAtt StatsTable.Arn
                                - !Sub "${StatsTable.Arn}/index/*"
                - PolicyName: SecretsManagerAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - secretsmanager:GetSecretValue
                            Resource:
                                - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:planly/jwt*"

    # Lambda Permission for API Gateway
    TodoLambdaApiGatewayInvokePermission:
        Type: AWS::Lambda::Permission
        Properties:
            FunctionName: !Ref TodoLambdaFunction
            Action: lambda:InvokeFunction
            Principal: apigateway.amazonaws.com
            SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PlanlyApi}/*/*"

    # Todo Lambda Function
    TodoLambdaFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: planly-api-todo-lambda
            Runtime: nodejs20.x
            Handler: dist/handlers/todo/index.handler
            CodeUri: ..
            Role: !GetAtt TodoLambdaExecutionRole.Arn
            Timeout: 30
            MemorySize: 256

    # ============================================
    # Stats Midnight Job (streak recalc 00:01)
    # ============================================

    # IAM Role for Stats Midnight Lambda
    StatsMidnightLambdaExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: planly-api-stats-midnight-lambda-role
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: lambda.amazonaws.com
                      Action: sts:AssumeRole
            ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
            Policies:
                - PolicyName: DynamoDBAccess
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action:
                                - dynamodb:PutItem
                                - dynamodb:GetItem
                                - dynamodb:UpdateItem
                                - dynamodb:Query
                                - dynamodb:Scan
                            Resource:
                                - !GetAtt CategoryTable.Arn
                                - !Sub "${CategoryTable.Arn}/index/*"
                                - !GetAtt UserTable.Arn
                                - !Sub "${UserTable.Arn}/index/*"
                                - !GetAtt HabitTable.Arn
                                - !Sub "${HabitTable.Arn}/index/*"
                                - !GetAtt TodoTable.Arn
                                - !Sub "${TodoTable.Arn}/index/*"
                                - !GetAtt StatsTable.Arn
                                - !Sub "${StatsTable.Arn}/index/*"

    # Stats Midnight Lambda Function
    StatsMidnightLambdaFunction:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: planly-api-stats-midnight-lambda
            Runtime: nodejs20.x
            Handler: dist/handlers/stats-midnight/index.handler
            CodeUri: ..
            Role: !GetAtt StatsMidnightLambdaExecutionRole.Arn
            Timeout: 120
            MemorySize: 256

    # IAM Role for EventBridge Scheduler (invoke Stats Midnight Lambda)
    StatsMidnightSchedulerExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: planly-stats-midnight-scheduler-role
            AssumeRolePolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: scheduler.amazonaws.com
                      Action: sts:AssumeRole
            Policies:
                - PolicyName: InvokeStatsMidnightLambda
                  PolicyDocument:
                      Version: "2012-10-17"
                      Statement:
                          - Effect: Allow
                            Action: lambda:InvokeFunction
                            Resource: !GetAtt StatsMidnightLambdaFunction.Arn

    # EventBridge Scheduler: run daily at 00:01 GMT-3 (replaces legacy scheduled rule)
    StatsMidnightSchedule:
        Type: AWS::Scheduler::Schedule
        DependsOn: StatsMidnightSchedulerExecutionRole
        Properties:
            Name: planly-stats-midnight-schedule
            Description: Trigger stats midnight job daily at 00:01 GMT-3
            ScheduleExpression: cron(1 0 * * ? *)
            ScheduleExpressionTimezone: "America/Sao_Paulo"
            FlexibleTimeWindow:
                Mode: "OFF"
            State: "ENABLED"
            Target:
                Arn: !GetAtt StatsMidnightLambdaFunction.Arn
                RoleArn: !GetAtt StatsMidnightSchedulerExecutionRole.Arn

Outputs:
    ApiUrl:
        Description: API Gateway endpoint URL
        Value: !Sub "https://${PlanlyApi}.execute-api.${AWS::Region}.amazonaws.com/prod/"
        Export:
            Name: !Sub "${AWS::StackName}-ApiUrl"

    PlanlyApiId:
        Description: API Gateway REST API ID
        Value: !Ref PlanlyApi
        Export:
            Name: !Sub "${AWS::StackName}-PlanlyApiId"

    CategoryLambdaFunctionName:
        Description: Category Lambda Function Name
        Value: !Ref CategoryLambdaFunction
        Export:
            Name: !Sub "${AWS::StackName}-CategoryLambdaFunctionName"

    CategoryTableName:
        Description: DynamoDB Category Table Name
        Value: !Ref CategoryTable
        Export:
            Name: !Sub "${AWS::StackName}-CategoryTableName"

    UserTableName:
        Description: DynamoDB User Table Name
        Value: !Ref UserTable
        Export:
            Name: !Sub "${AWS::StackName}-UserTableName"

    HabitLambdaFunctionName:
        Description: Habit Lambda Function Name
        Value: !Ref HabitLambdaFunction
        Export:
            Name: !Sub "${AWS::StackName}-HabitLambdaFunctionName"

    HabitTableName:
        Description: DynamoDB Habit Table Name
        Value: !Ref HabitTable
        Export:
            Name: !Sub "${AWS::StackName}-HabitTableName"

    TodoLambdaFunctionName:
        Description: Todo Lambda Function Name
        Value: !Ref TodoLambdaFunction
        Export:
            Name: !Sub "${AWS::StackName}-TodoLambdaFunctionName"

    TodoTableName:
        Description: DynamoDB Todo Table Name
        Value: !Ref TodoTable
        Export:
            Name: !Sub "${AWS::StackName}-TodoTableName"

    StatsMidnightLambdaFunctionName:
        Description: Stats Midnight Lambda Function Name
        Value: !Ref StatsMidnightLambdaFunction
        Export:
            Name: !Sub "${AWS::StackName}-StatsMidnightLambdaFunctionName"

    StatsMidnightScheduleName:
        Description: EventBridge Scheduler schedule for stats midnight job
        Value: !Ref StatsMidnightSchedule
        Export:
            Name: !Sub "${AWS::StackName}-StatsMidnightScheduleName"
